<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>shorty - mini URL shortener</title>
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial;
        max-width: 720px;
        margin: 40px auto;
        padding: 0 16px;
      }
      h1 {
        font-size: 1.6rem;
      }
      form,
      .list {
        margin-top: 20px;
      }
      input[type="text"] {
        width: 100%;
        padding: 10px;
        margin: 6px 0;
        box-sizing: border-box;
        border: 1px solid #ccc;
        border-radius: 6px;
      }
      button {
        padding: 10px 14px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background: #111;
        color: #fff;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
      }
      th,
      td {
        border-bottom: 1px solid #eee;
        padding: 8px;
        text-align: left;
        font-size: 14px;
      }
      code {
        background: #f5f5f5;
        padding: 2px 6px;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <h1>shorty</h1>
    <p>ミニURL短縮サービス。下のフォームから登録できます。</p>

    <form id="f">
      <label
        >URL
        <input
          id="url"
          type="text"
          placeholder="https://example.com/very/long/path?..."
          required
        />
      </label>
      <label
        >カスタムコード（任意）
        <input
          id="custom"
          type="text"
          placeholder="my-code (英数/ _ - 3〜32字)"
        />
      </label>
      <button>短縮する</button>
    </form>

    <div class="list">
      <h2>登録一覧</h2>
      <table id="tbl">
        <thead>
          <tr>
            <th>コード</th>
            <th>URL</th>
            <th>クリック</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <script>
      const tbody = document.querySelector("#tbl tbody");
      const load = async () => {
        const res = await fetch("/api/list");
        const data = await res.json();
        tbody.innerHTML = "";
        data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        for (const row of data) {
          const tr = document.createElement("tr");
          const shortUrl = `${location.origin}/${row.code}`;
          tr.innerHTML = `
          <td><a href="${shortUrl}" target="_blank"><code>${row.code}</code></a></td>
          <td style="word-break:break-all;"><a href="${row.url}" target="_blank">${row.url}</a></td>
          <td>${row.clicks}</td>
          <td><button data-del="${row.code}">削除</button></td>
        `;
          tbody.appendChild(tr);
        }
        tbody.querySelectorAll("button[data-del]").forEach((btn) => {
          btn.onclick = async () => {
            if (!confirm("削除しますか？")) return;
            const code = btn.getAttribute("data-del");
            const res = await fetch(`/api/${code}`, { method: "DELETE" });
            if (res.ok) load();
            else alert("削除失敗");
          };
        });
      };

      document.getElementById("f").onsubmit = async (e) => {
        e.preventDefault();
        const url = document.getElementById("url").value.trim();
        const custom = document.getElementById("custom").value.trim();
        const res = await fetch("/api/shorten", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url, custom }),
        });
        if (res.ok) {
          document.getElementById("url").value = "";
          document.getElementById("custom").value = "";
          load();
        } else {
          const t = await res.text();
          alert("登録失敗: " + t);
        }
      };

      load();
    </script>
  </body>
</html>
